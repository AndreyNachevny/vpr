# Лаба №2. Настройка маршрутизации и ssh

## Файлы к лабе

- Порядок выполнения [(.pdf)](http://s.nektools.ru/LabWork_1.pdf)
- Пример отчёта [(.docx)](http://s.nektools.ru/%D1%81%D0%B5%D1%82%D0%B8%20%D0%BB1%20%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80%20%D0%BE%D1%82%D1%87%D0%B5%D1%82%D0%B0.doc)

## Инструкция по выполнению лабы (от Горшочка)

- В случае обнаружения логических ошибок писать [сюда](https://vk.com/wkeep), открывать [Issues](https://github.com/whitekeep/vpr12/issues) или делать [Pull Requests](https://github.com/whitekeep/vpr12/pulls)
- При обнаружении орфаграфических или пунктационных ошибок вы можете самостоятельно редктировать инструкцию при наличии доступа

## Скачиваем образы дистрибутивов

Для выполнения этой лабы нам понадобиться скачать:

- [Oracle VirtualBox](https://download.virtualbox.org/virtualbox/6.1.32/VirtualBox-6.1.32-149290-Win.exe)
- [Ubuntu 20.04 LTS (в первой лабе был такой же)](https://releases.ubuntu.com/20.04.3/ubuntu-20.04.3-live-server-amd64.iso)

Можно использовать любой другой дистрибутив линукса. Главное чтобы была поддержка всех необходимых сетевых утилит

### Особенноти установки VirtualBox

- Необходиом согласиться на установку драйвера когда появиться соответсвующее диалоговое окно

### Особенности использования Ubuntu

- Аккуратнее с [выключением](./lab2.md#как-закрывать-машины) вм
- Во время исподьзования убунтой не выполняйте `apt upgrade`. Это излишне (выполняется 20 минут и займёт кучу места на диске)
- Всё делаем из под `sudo`
- Иногда опущенные интерфейсы сами поднимаются. Если это происходит, вы что-то делаете не так. Следите за этим моментом

## Создание ВМ

- Создадим ВМ
- ![create](https://i.imgur.com/On8N8Rf.png)
- Выбереем версию ОС
- ![settings](https://i.imgur.com/2b4xw0r.png)
- Оперативную память ставим по умолчанию 1024МБ. После заершения установки мы поменяем кол-во памяти на 512МБ для экономии памяти.
- ![settings2](https://i.imgur.com/gnp1p1o.png)
- Создадим виртуальный жёсткий диск
- ![fincreate](https://i.imgur.com/uh6r22h.png)
- Далее
- ![fin2create](https://i.imgur.com/baFzuR3.png)
- Далее
- ![fin3create](https://i.imgur.com/kZmeLQg.png)
- Далее
- ![fin4create](https://i.imgur.com/cLDM4ZZ.png)
- Заходим в настройки ВМ
- ![fin5create](https://i.imgur.com/K9wLNgT.png)
- Стваим галочку возле Сеть в Порядке загрузки
- ![settingssetonvm](https://i.imgur.com/ttStJ0b.png)

## Устанавливаем ОС

### Выбираем образ

- Запускаем ВМ
- ![startvm](https://i.imgur.com/qBeMZ4V.png)
- Выбираем загрузочный диск
- ![choose](https://i.imgur.com/ByXzdhx.png)
- Жмём Добавить
- ![press](https://i.imgur.com/UsyVGUG.png)
- Выбираем скачанный обзар в проводнике
- ![chooseinexp](https://i.imgur.com/rUnOQ4z.png)
- Выбираем из списка
- ![chosefromlist](https://i.imgur.com/9DI1yQD.png)
- Продолжить
- ![next](https://i.imgur.com/hFFN4IV.png)

### Установка

- Выбираем русския язык. Навигация происходит только с помощь клавиш клавиатуры
- ![chrus](https://i.imgur.com/tzGpm9m.png)
- Продолжить без обновления
- ![next](https://i.imgur.com/UhXtL3K.png)
- Готово. Тут мы не мучаемся и выбираем только Английскую раскладку. Из-за этого в убунте мы сможем писать только на английском
- ![next](https://i.imgur.com/yTvbTwH.png)
- Готово
- ![next](https://i.imgur.com/Z3yFvOs.png)
- Готово
- ![next](https://i.imgur.com/83LamPB.png)
- Готово
- ![next](https://i.imgur.com/QRWdQ1o.png)
- Клавишой Вниз идём до Готово и жмём интер
- ![next](https://i.imgur.com/erQT5q5.png)
- Готово
- ![next](https://i.imgur.com/FRKSoHc.png)
- Продолжить
- ![next](https://i.imgur.com/MNbsFUn.png)
- Заполняем поля на сувой вкус и цвет. После жмём Готово
- ![next](https://i.imgur.com/SRzjaoz.png)
- Ставим Х возле пункта установки OpenSHH сервера и жмём Готово
- ![openssh](https://i.imgur.com/yAIWz5g.png)
- Ничего из этого нам не нужно. Жмём Готово
- ![nonepacknext](https://i.imgur.com/iGZkrqs.png)
- Активируем режим ждуна
- ![zhdun](https://i.imgur.com/roltcQZ.png)
- Как только появляется вторая строчка жмём клавишу вниз и Отменяем загрузку обновления (нам оно не нужно)
- ![noupdate](https://i.imgur.com/rzEJfAA.png)
- Тут жмём Enter
- ![enter](https://i.imgur.com/S8IDKsC.png)

Готово. Убунту установлена

## Первичная настройка

### Доустанавливаем пакеты

1. Входим в убунту
2. Повыщаем права до суперпользователя командой `sudo su`
3. Обновляем списки пакетов `apt update`
4. Устанавливаем пакет для просмотра arp таблиц `apt install net-tools`
5. И стваим screen `apt install screen`. Он может пригодиться
6. Завершаем работу ВМ

### Настраиваем сеть на ВМ

- Заходим в настройки ВМ
- ![gotosettings](https://i.imgur.com/K9wLNgT.png)
- Выставляем следующие настроки сети для Адаптера 1
- ![setsetiad1](https://i.imgur.com/arAdHp0.png)
- И следующие для Адаптера 2 и жмём ОК
- ![setsetiad2](https://i.imgur.com/BNwAIOn.png)

### Урезаем кол-во оперативной памяти

Для нашего дистрибутива (без графики) будет достаточно 512МБ оперативной памяти на ВМ

- Заходим в настройки
- ![toset](https://i.imgur.com/K9wLNgT.png)
- Уменьшаем память
- ![minopera](https://i.imgur.com/1yGi9Xf.png)
- Готово

### Клонирование ВМ

Дважды клонируем нашу ВМ со слежующими параметрами:

- Клонирование
- ![cloning](https://i.imgur.com/G1QrL7F.png)

- Также выставим название при первом клонировании `Two - Ubuntu` и при втором `Three - Ubuntu`. Это необходимо для удобства различимости их между собой
- ![setclon](https://i.imgur.com/d06VaIT.png)
- Выбираем Полное копирование
- ![set2clon](https://i.imgur.com/oQsY3z1.png)
- В итоге получаем три ВМ:
- ![allvms](https://i.imgur.com/dyJbJeQ.png)

Готово. Первичная настройка завершена

## Настраиваем сеть на машинах

- Повысим права `sudo su` и выполняем `ip a`. Видим что у `enp0s8`нету апишника
- ![look](https://i.imgur.com/cNsMwDu.png)
- Выдадим его `dhclient enp0s8` и проверим повторно командой `ip a`. Всё отлично, он появился
![addip](https://i.imgur.com/ScaBEjH.png)
- Выполним так для каждой из трёх машин

## Протоколирование IP

Запишем все наши айпишники в табличку

Пример таблички:

|№|Интерфейс|ВМ 1|ВМ 2|ВМ 3|
|---|---|---|---|---|
|1|enp0s3|`192.168.0.110`|`192.168.0.111`|`192.168.0.112`|
|2|enp0s8|`192.168.56.109`|`192.168.56.110`|`192.168.56.111`|

Пропингуем с кайждой машины оба айпишника каждой другой машины с помощью `ping -c 2 <тут айпишник вместо скобок>`
Если всё как на скрине, то всё ок, иначе вам стоит перечитать инструкцию

![ping](https://i.imgur.com/wHIkmaK.png)

После пинга всего и всё просмотрим на каждой из трёх машин таблицы маршрутизации командой `route -n`

![route](https://i.imgur.com/dIw5FVd.png)

## Выключаем интерфейсы

Для выключения интерфейсов используем следующую команду:

```sh
ip link set dev enp0s3 down
```

Тут enp0s3 это имя интерфейса который мы выключаем

Далее нам надо выключить следующие интерфейсы:

- на `ВМ 1` выключаем `enp0s3` (первый интерфейс)
- на `ВМ 3` выключаем `enp0s8` (второй интерфейс)

## Проверяем доступность с ВМ 1 на ВМ 3

Просмотрим маршруты командой `route -n` с первой и с третей машины. Если  пропали соответсвующие интерфейсы на каждой машине, то мы молодцы. Нет, читаем ещё раз инструкцию и переделываем

Далее выполним с ВМ 1 пинг

```sh
ping -c 4 <ip_машины_3>
```

Пингуем оба айпишника третей машины. Если ничего не пингуется, то всё ок

![notping](https://i.imgur.com/t24BlZa.png)

## Прописываем шлюз

Теперь наша задача получить нормально пропинговаться с ВМ 1 до ВМ 3. Для этого поставим шлюз

Шлюзом у нас будет выступать ВМ 2

Нам понадобиться айпишник ВМ 2 от Виртуального адаптера хоста (это у нас enp0s8)

![ipfopr3](https://i.imgur.com/F18n36Y.png)

И прописываем на первой машине:

```sh
route add -net 192.168.0.0 netmask 255.255.255.0 gw 192.168.56.110
```

- `192.168.0.0` это сеть 1-го адптера ВМ 3 (ip в котором поставили всесто последнего октета нолик)
- `192.168.56.110` это у нас ip ВМ 2

Напомню, что с выключенными интерфейсами табличка у нас сейчас выглядит вот так:

|№|Интерфейс|ВМ 1|ВМ 2|ВМ 3|
|---|---|---|---|---|
|1|enp0s3| - |`192.168.0.111`|`192.168.0.112`|
|2|enp0s8|`192.168.56.109`|`192.168.56.110`| - |

## Теперь пропишем новый маршрут на ВМ 3

От ВМ 2 возьмём следующий ip:

![ipvm22](https://i.imgur.com/bEJuWUd.png)

И выполним на ВМ 3 команду:

```sh
route add -net 192.168.56.0 netmask 255.255.255.0 gw 192.168.0.111
```

- `192.168.56.0` это сеть 2-го адптера ВМ 1 (ip в котором поставили всесто последнего октета нолик)
- `192.168.0.111` это у нас ip ВМ 2

Снова делаем пинг от ВМ 3 до ВМ 1. Пинг есть, всё отлично. Нету, то читаем инструкцию заново и переделываем

## Попытка пинга

Теперь давайте попробовать пропинговатья с ВМ 1 на ВМ 3
IP у нас у ВМ 3 только один, проблем с определением быть не должно

А проблемы с пингом нормальны. Если их нет, всё равно продолжаем делать далле лабу

## Проверка активации перенаправления ip

Выполним команду на ВМ 2:

```sh
cat /proc/sys/net/ipv4/ip_forward
```

Выводом является одна цифра

Сравним ответ и следущее ваше действие по табличке

|Вывод|Пингуется|Не пингуется|
|---|---|---|
|0|Всё плохо, читаем инструкцию и переделываем|Ок, идём к след. шагу|
|1|Всё отлично, пропускаем след. шаг|Всё плохо, читаем инструкцию и переделываем|

## Решаем проблему с пингом

Для решения нужно включить ip_forward

Выполняем следующую команду на ВМ 2:

```sh
echo "1" > /proc/sys/net/ipv4/ip_forward
```

И снова проверим:

```sh
cat /proc/sys/net/ipv4/ip_forward
```

Если вывод теперь `1`, то всё отлично, теперь снова попробуем пропинговать ВМ 3 с ВМ 1

## ВАЖНО

На ВМ 1 делаем пинг. Если пинг есть, то всё отлично. Нету, читаем инструкцию заново и переделываем

Внимание! Интерфейс на ВМ 3 может всё время сам подниматься. Опускайте его всё время вручную.

Также Новиков НЕ ДОЛЖЕН об этом знать.

Знаю, пока костыль, эксперименты продолжаются по решению этой проблемы.

## Полезность

Просмотр маршрута пакетов с ВМ 1

```sh
tracepath 192.168.0.112
```

(тут я указал ip от ВМ 3)

## Создадим пароль на root

(ремарка: хоть мы так и делаем для лабы, в реальной жизни так делать не надо, иначе твой сервер взломают за пол часа)

Необходимо поставить пароль на пользователя root на ВМ 3

Делаем следующее на ВМ 3

- Повышаем права `sudo su`
- Меняем пароль с помощью `passwd`
- Прописываем новый пароль
- Готово

## Разрешаем root ssh

На ВМ 3 отредактируем слудующий конфиг с помощью `nano`

```sh
nano /etc/ssh/sshd_config
```

И прописываем так чтобы было так:

```sh
PermitRootLogin yes
```

![rootssh](https://i.imgur.com/AKR6mp8.png)

Сохраняем конфиг

Перезапускаем ssh сервер:

```sh
systemctl restart ssh || systemctl restart sshd
```

Готово

## Подключаемся по ssh

SSH сервер на машине позволяет дать удалённый доступ на управление ей.

ВМ 1 у нас будет в роли клиента, а ВМ 3 в роли сервера (управляемой)

На ВМ 3 по умолчанию ssh сервер уже запущен (если устанавливали линукс по инструкции)

На ВМ 1 выполняем команду для поключению к ВМ 3

```sh
ssh root@192.168.0.112
```

- `192.168.0.112` - ip от ВМ 3

- У вас спросят про довереность отпечатка ключа. Пишем ему в ответ слово `yes` и жмём enter

Теперь для теста создадим фалик на ВМ 3 через ВМ 1
(мы сейчас всё ещё сидим на ВМ 1)

Повышать права тут не надо, выше просто уже некуда

1. Перейдём создадим папку в корне `mkdir /files`
2. Создадим там файл `touch /files/test.txt`
3. Теперь зайдём на ВМ 3 и просмотрим там файл `ls /files`
4. Файл `test.txt` тут, то всё ок, иначе читаем инструкцию заново

## Просмотр потока трафика

Во время ssh сесии просмотрим как бежит ~~говно~~ трафик по трубам

На ВМ 2 пишем:

```sh
tcpdump -i enp0s3
```

- `enp0s8` - это имя  интерфейса ВМ 2 (какйо из смотрите сами, там где нету кучи UDP - наше)

Наблюдаем и анализируем что у нас показывается

Разбираем что это самостоятельно с помощью гугла, новиков придерётся

Также гуглим что такое `arp` и `ssh`

## Делаем петлю

Возвращаемся к ВМ 1

Запустим петлю с помощью `tcpdump` поверх сесии ssh

```sh
tcpdump -i enp0s3
```

- `enp0s3` - единственный рабочий интерфейс ВМ 3

Смотрим поток ~~говна~~ трафика

Как насмотримся, жмём `ctrl+c` до посинения, пока не завершим выполнение

## Выход из ssh

Теперь вернёмся к ВМ 1 и выйдем из ssh сессии

```sh
exit
```

Мы вышли из ssh сессии

## Как закрывать машины

1. Закрываем ВМ 3 с сохранением состояния
2. Остальные две закрываем как можем (с сохранением - идеально, нет - увы и ах)

## Как запустить машины повторно

1. Запускаем ВМ 3
2. Запускаем остальные две
3. Входим везде, повышаем права до суперпользователя `sudo su`
4. В той же последовательности делаем на каждой из них пункт [1](./lab2.md#настраиваем-сеть-на-машинах), [2](./lab2.md#протоколирование-ip) и [3](./lab2.md#выключаем-интерфейсы)
5. Согласно новой таблице делаем всё повторно (если ip все совпали, вам повезло)
6. [Прописывае везде повторно шлюз](./lab2.md#прописываем-шлюз)
7. И всё остальное что касалось сети (изменение пользователя и конфигов сюда не входит)

## Пожертвования

Вы можете в любой момент пожертвовать Гороху за такой труд, связвшись с ним в [ВК](https://vk.com/wkeep) :3

Также благодарочка Боярышнику за помощь. Он кста обожает пончики, вы знаете [что делать](https://vk.com/jkearnsl) : D
