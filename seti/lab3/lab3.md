# Лаба №3. Настройка системы обмена почтой (В процессе)

## Файлы к лабе

- Порядок выполнения (версия 1) [(.docx)](https://github.com/whitekeep/vpr12/raw/main/seti/lab3/Labwork_3.docx)
- Порядок выполнения (подробная версия) [(.pdf)](https://github.com/whitekeep/vpr12/raw/main/seti/lab3/LabWork_3_v2.pdf)
- Пример отчёта [(.doc)](https://github.com/whitekeep/vpr12/raw/main/seti/lab3/example_report_3.doc)

## Инструкция по выполнению лабы (от Бояршинова)

- В случае обнаружения логических ошибок писать [сюда](https://vk.com/jkearnsl), открывать [Issues](https://github.com/whitekeep/vpr12/issues) или делать [Pull Requests](https://github.com/whitekeep/vpr12/pulls)
- При обнаружении орфаграфических или пунктационных ошибок вы можете самостоятельно редктировать инструкцию при наличии доступа
- Горох временно отсутствует

## Скачиваем образы дистрибутивов

Для выполнения этой лабы нам понадобиться скачать:

- [Oracle VirtualBox](https://download.virtualbox.org/virtualbox/6.1.32/VirtualBox-6.1.32-149290-Win.exe)
- [Ubuntu 20.04 LTS (в первой лабе был такой же)](https://releases.ubuntu.com/20.04.3/ubuntu-20.04.3-live-server-amd64.iso)

Можно использовать любой другой дистрибутив линукса. Главное чтобы была поддержка всех необходимых сетевых утилит

### Особенноти установки VirtualBox

- Необходиом согласиться на установку драйвера когда появиться соответсвующее диалоговое окно

### Особенности использования Ubuntu

- Всё делаем из под `sudo`, лучше сразу прописать `sudo su`

## Создание ВМ

- Создадим ВМ
- ![create](https://i.ibb.co/Y2tR2wd/image.png)
- Выбереем версию ОС
- ![create](https://i.ibb.co/4JSbrwj/image.png)
- Выбереем кол-во ОЗУ и жмем далее
- ![create](https://i.ibb.co/5RWTs7h/image.png)
- ![create](https://i.ibb.co/9wrpj4x/image.png)
- ![create](https://i.ibb.co/x6qQ1CC/image.png)
- ![create](https://i.ibb.co/MZf8stW/image.png)
- ![create](https://i.ibb.co/7SjtjVz/image.png)
- Настроим ВМ
- ![settings](https://i.imgur.com/fxdntyJ.png)
- Выберем образ Ubuntu или другой unix OS (в моем случае ссылка на файл сохранилась, выбирарю его)
- ![settings](https://i.imgur.com/PHetOky.png)
- Далее следует выбрать сеть, в которой будет работать наша почта (я выбрал всеми знакомый "виртуальный хост адаптера") и нажимаем "Ok"
- ![settings](https://i.imgur.com/8Xqg57u.png)
ВМ создана, нам потребуется:
- Для оценки <<отлично>> модель MUA -> MTA -> MTA: 2 сервера и 1 клиент => всего 3 машины. 
- Для оценки <<хз>> модель MUA -> MTA -> MUA: 1 сервер и 2 клиента => всего 3 машины. 
- Для <<оценки>> модель MUA -> MTA: 1 сервер 1 клиент => всего 2 машины. 

- Запускаем эту(что сейчас создали), устанавливаем ОС (процесс установки можно глянуть в инструкции 2й лабы)
- после установки ОС нужно послать сингнал завершения работы и клонировать машину 2 раза, чтобы получилось 3 машины(для первых 2х мделей):
- ![settings](https://i.imgur.com/miR7JtM.png)
- ![settings](https://i.imgur.com/UDaONlr.png)
- ![settings](https://i.imgur.com/IZFBw6f.png)
- Повторяем процедуру ещё 1 раз и получаем следующую картину(для первых двух моделей в моем случае):
- ![settings](https://i.imgur.com/s8kZKMf.png)

## Установка компонентов

Нам следует установить нужные компоненты, чтобы всё работало хорошо и чтобы не возвращаться к этому в будущем

Для серверной ВМ (в моем случае "mail-server") следует установить следующие компоненты: sendmail, ...
Чтобы это сделать, пропишите следующее в консоль:
```sh
sudo su
```
- после чего введите пароль
```sh
apt-get update
```

```sh
apt-get install sendmail
```

```sh
apt-get install net-tools
```
...

Для клиентских ВМ (в моем случае "mail-client" и "mail-client2") следует установить следующие компоненты: mutt, ...
Чтобы это сделать, пропишите следующее в консоль:
```sh
sudo su
```
- после чего введите пароль
```sh
apt-get update
```

```sh
apt-get install mutt
```

```sh
apt-get install mailutils
```

```sh
apt-get install net-tools
```
...


Но вы столкнетесь с проблемой того, что у Вас не будет доступа к интернету
потому что мы выбрали виртуальный хост адаптера (более надежный, чем NAT, но последний предоставляет доступ к интернету)
Следующий пункт для решения этой проблемы

### Временное включение интернета
Установим пару компонентов, но для начала включим интернет на время установки(операцию стоит провести для каждой ВМ отдельно):
- ![settings](https://i.imgur.com/IuznTwz.png)
- Переключимся временно на NAT
- ![settings](https://i.imgur.com/qYKuBtY.png)
- Устанавливаем компоненты с "включенным интернетом"
- ![settings](https://i.imgur.com/nucVssS.png)
Компоненты установлены, выключаем NAT
и включаем обратно наш адаптер виртуального хоста:
- ![settings](https://i.imgur.com/IuznTwz.png)
- ![settings](https://i.imgur.com/0WWmr1G.png)
Готово, можно приступать к основной работе

## Сбор информации, настройка статических IP
Чтобы нам не страдать, советую собрать ip всех машин в столбик,
а так же настроить статические ip на всех 3х машинах.

### Настройка статического ip
Зададим ip адрес вручную (без DHCP)

- Для ВМ "mail-server" я задам ip `192.168.56.105`
- Для ВМ "mail-client" - `192.168.56.106`
- Для ВМ "mail-client2" - `192.168.56.107`

- Почему именно такой? Просто потому что я так захотел

- Следующую процедуру следует повторить для каждой ВМ,
- я продемонстрирую на примере для ВМ "mail-server":

- Прописываем в консоль команду:
```sh
sudo nano /etc/netplan/*.yaml
```
- Открылся редактор файла XXX.yaml; "nano" в linux - как программа "блокнот" в windows
![ipsettings](https://i.imgur.com/dl4om5J.png)
- Далее прописываем следующее, как у меня, только с вашим ip и сетью:
![ipsettings](https://i.imgur.com/biRnrln.png)
- Обратите внимание: стоит соблюдать отступы(пробелы)
- совет: смотрите под какой буквой какая строка начинается.

- Далее жмем `Ctrl+O` , далее `Enter` , далее `Ctrl+X`
- Готово! Мы написали конфиг для ВМ "mail-server", теперь следует его применить:

- Прописываем в консоль:
```sh
sudo netplan apply
```
- А далее: 
```sh
sudo netplan try
```

- В консоли появилось предупреждение:
![ipsettings](https://i.imgur.com/j4ZvI5B.png)
- Жмем `Enter`
![ipsettings](https://i.imgur.com/924bS5D.png)
- Готово! Если нет ошибок, то всё получилось, 
если есть, то перепроверьте снова файл конфига и повторите процедуру.

- Можно проверить и удостовериться, что ip адрес поменялся на нужный нам, прописав в консоль:
```sh
ip a
```
![ipsettings](https://i.imgur.com/hRVXxjz.png)
- Повторите процедуру для оставшихся машин


### Сбор информации о машинах
Соберем информацию о 3х машинах в столбик (послезно для первых 2х моделей)

|№|Интерфейс|ВМ mail-server|ВМ mail-client|ВМ mail-client2|
|---|---|---|---|---|
|1|enp0s3|`192.168.56.105`|`192.168.56.106`|`192.168.56.107`|

(У Вас ip и кол-во машин может отличаться)

## Настройка почтового сервера
В моем случае я буду настраивать ВМ с названием "mail-server"

### Подготовка начальной конфигурации почтового сервера
- Откроем директорию `/etc/mail` прописав в консоль:
```sh
cd /etc/mail
```
![settings](https://i.imgur.com/nS3kGuJ.png)

- В файле /etc/mail/access устанавливаются права доступа
- Дадим разрешение на отправку почты от наших клиентов(ВМ "mail-client" и "mail-client2"), прописав
- их ip адреса в столбик через любой редактор (например nano/vim) или просто введя в консоль:

```sh
echo "192.168.56.106 RELAY" >./access
```

```sh
echo "192.168.56.107 RELAY" >./access
```
- Где `192.168.56.106` и `192.168.56.107` - ip адреса разрешенных [клиентов](https://github.com/whitekeep/vpr12/blob/main/seti/lab3/lab3.md#%D1%81%D0%B1%D0%BE%D1%80-%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%86%D0%B8%D0%B8-%D0%BE-%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D0%B0%D1%85) (ВМ mail-client и ВМ mail-client2)

- Создадим таблицу разрешенных клиентов, введя в консоль:
```sh
make access.db
```

![settings](https://i.imgur.com/M47whUa.png)
Готово

### Обьявление локальных доменов для ящиков
Объявляем имя домена, для которого sendmail адреса почтовых ящиков будет считать
локальными. Эту процедура нужна для того, чтобы занимать "красивые" адреса в локальной сети, типа
"example@nikita.com"; Введенные доменные имена будут считаться локальными.

- Я выберу для себя доменное имя в локальной сети: "mail.ru"

Для этого пропишу следующие команды:
```sh
echo -e "mail.ru\nmail" >local-host-names
```

```sh
echo "mail.ru mail" >domaintable
```

```sh
make domaintable.db
```
Это должно исключить попытки sendmail осуществить маршрутизацию почты при помощи DNS

Eсли вы укажете не объявленное имя домена то возможны такие ответы sendmail:
- Deferred: mail.ru.: No route to host
- Deferred: mail.ru.: Network is unreachable

### Тестовая локальная отправка на почту
Так как в прошлом пункте мы задали в таблицу доменов красивое имя, то теперь мы должны задать для этого имени адрес сервера, на который будет оно ссылаться!
Почти в любых системах это можно сделать, настроив hosts файл, который подобен DNS:

- Пропишите в консоль:
```sh
sudo nano /etc/hosts
```
- Далее вы увидите примерное такую картину:
-![hosts](https://i.imgur.com/AjUMNVg.png)
- Измените параметры на подобные этому скриншоту:
-![hosts](https://i.imgur.com/2bOzblz.png)
Где первый столбик - адрес вашей серверной машины (mail-server в моем случ); второй - красивое локальное доменное имя, что я задал выше, и третий - сетевое имя ВМ.
После чего нажмите `Ctrl+O` , далее `Enter` , далее `Ctrl+X` - чтобы сохранить изменения. Готово

- Далее я советую опытным перезагрузить демон, а остальным просто написать в консоль команду перезагрузки:

```sh
reboot
```
Не забываем при `reboot` заново заходить под `sudo su`!

Следующим шагом я советую выполнить следующую команду, чтобы быть уверенным, что сервис почты запущен(хотя демон сам должен стартовать процесс)
- запуск почтового сервиса:

```sh
/usr/sbin/sendmail -bd -q25m
```

Готово, можно тестировать :D

Отправим локально тестовое сообщение, введя в консоль:
```sh
echo -e "Hello world\!" | sendmail root@mail.ru
```
где 
- `root` - имя пользователя (мы прописывали `sudo su` в самом начале, чтобы зайти за пользователя `root`)
- `mail.ru` - локальный домен, который мы задали в самом начале

Если после отправки нет ошибок, то давайте проверим нашу почту
- Откроем папку с входящими сообщениями, прописав:
```sh
nano /var/mail/root
```
где `root` - имя пользователя; получим:
![maillist](https://i.imgur.com/Cl7v2rW.png)
- Это список полученных сообщений у пользователя root
- `Ctrl+X` чтобы выйти

### Настройка глобальной доставки писем в сети
Чтобы сервер smtp мог быть доступен в сети, следует немного поправить конфиг

- Для начала проверим, в какой сети слушается 25 порт (порт smtp):
```sh
netstat -an | grep 25
```
В строке 127.0.0.1:25 (если ничего нет, перезапустите sendmail, прописав: `/usr/sbin/sendmail -bd -q25m` в консоль)

- Изменим это в конфиге sendmail'a, прописав в консоль:
```sh
nano /etc/mail/sendmail.cf
```
- Откроется большой конфиг sendmail'a, Вам следует пролистать до следующей строки(будьте бдительнее, можно случайно пропустить )
![globalacc](https://i.imgur.com/CYTZ5mi.png)
- Меняем значения на те, что у меня и сохраняем:
`Ctrl+O` , далее `Enter` , далее `Ctrl+X`. Готово.

- Перезагружаем демон sendmail или ВМ `reboot`
Не забываем при `reboot` заново заходить под `sudo su`!

## Настройка клиентской части
Клиентские ВМ настраиваются следующим образом.
Я буду провидить действия от имени машины `mail-client`.
Приступим!

- Сразу не забываем зайти за супер пользователя
```sh
super su
```

- Проверим, что mutt установлен, введя в консоль:
```sh
mutt
```
![mutt](https://i.imgur.com/0pX2zVD.png)

Если Вы забыли его установить, но проделали на этой ВМ какой-то труд, в конце статьи есть
решение проблем

- Mutt установлен, закрываем его `Ctrl+Z`

- Теперь нам следует изменить конфиг mutt'a, прописав следующее в консоль:
```sh
nano ~/.muttrc
```
- Откроется пустой файл, впишем туда информацию (как на след скриншоте):
-![conf](https://i.imgur.com/A6jAubI.png)
Где: 
- `192.168.56.105 - ip адрес mail-server
- `ralname="Nikita"` - любое ваше имя
- `from="client1@mail.ru"` - любой ящик

После, нажимаем `Ctrl+O` , далее `Enter` , далее `Ctrl+X` чтобы сохранить и выйти. Готово.

(возможно потребуется перезапустить демон, но это не точно)


## Модель: MUA -> MTA
Настроим для модели MUA -> MTA. Нам понадобится `mail-server` и `mail-client`; 
Я буду провидить действия от имени машины `mail-client`.
Приступим!

- Запускаем mutt, введя в консоль mutt
```sh
mutt
```
Тут нас встречает удобный интерфейс, нажимаем `m` на клавиатуре, чтобы отправить писмо и вводим получателя (для теста сервера, выберу `root@mail.ru` - те серверный email):
![mutt](https://i.imgur.com/mfshARj.png)
- Далее вводим тему сообщения(для подтверждения используйте `Enter` на клавиатуре):
![muttsu](https://i.imgur.com/Bl5HV3v.png)
- Далее откроется всеми любимый редактор nano, в который вводим текст сообщения и нажимаем `Ctrl+O` , далее `Enter` , далее `Ctrl+X`
![mutttext](https://i.imgur.com/APBIbB1.png)
- Далее сформируется сообщение, где будет отражена оснавная информация и файл с текстом
![muttmsg](https://i.imgur.com/22WnGBZ.png)
- Нажимаем тут `y` на клавиатуре, чтобы отправить сообщение
![muttmsg](https://i.imgur.com/22WnGBZ.png)
- Пройдет секунд 5 с надписью "connecting"
![muttsend](https://i.imgur.com/NmptjBo.png)
- Сообщение успешно отправлено
![muttsend](https://i.imgur.com/MYO2AFl.png)

Если на этом этапе возникли проблемы, пишите мне.

- Проверка, что письмо дошло до ВМ `mail-server`:
Открываем ВМ `mail-server`, прописываем в консоль:
```sh
nano /var/mail/root
```
пролистываем в самый низ:
![msginroot](https://i.imgur.com/0Sm380i.png)
Вот наше сообщение доставлено, всё работает :)

## Модель  MUA -> MTA -> MUA (в разработке)
Теперь мы умеем отправлять сообщения, но для работы модели  MUA -> MTA -> MUA нам нужно
отправить сообщение конечному пользователю, а мы пока отправили только в MTA
=> настройте тоже самое на ВМ mail-client2

После настройки ВМ mail-client и ВМ mail-client2 составим таблицу email адресов для удобства:

|№|ВМ|Email|
|---|---|---|
|1|mail-client|`client1@mail.ru`|
|2|mail-client2|`client2@mail.ru`|



- Отправим сообщение из ВМ mail-client в ВМ mail-client2 через MTA mail-server:
![fromvmonetovmtwo](https://i.imgur.com/NrKAYQr.png)
- Слева - `mail-client2`; справа - `mail-client`; Отправляем сообщение на адрес client2@mail.ru, как мы уже умеем:
![imf](https://i.imgur.com/2OvGMRZ.png)
- Нажимаем `y` для отправки и смотрим:


## Модель  MUA -> MTA -> MTA (в разработке)
Передача сообщения от MUA (клиента) через MTA1 в MTA2



# Вывод
Какую выбрать модель - решать вам. Все модели составлены по домыслам студентов. Лаба сложная и моментами непонятная. Я не гарантирую, что модель MUA -> MTA
вообще прокатит, как и остальные. Если у Вас есть полезная информация, милости прошу в [VK](https://vk.com/jkearnsl).



