# Лаба №3. Настройка системы обмена почтой

## Файлы к лабе

- Порядок выполнения (версия 1) [(.docx)](https://github.com/whitekeep/vpr12/raw/main/seti/lab3/Labwork_3.docx)
- Порядок выполнения (подробная версия) [(.pdf)](https://github.com/whitekeep/vpr12/raw/main/seti/lab3/LabWork_3_v2.pdf)
- Пример отчёта [(.doc)](https://github.com/whitekeep/vpr12/raw/main/seti/lab3/example_report_3.doc)

## Инструкция по выполнению лабы (от Бояршинова)

- В случае обнаружения логических ошибок писать [сюда](https://vk.com/jkearnsl), открывать [Issues](https://github.com/whitekeep/vpr12/issues) или делать [Pull Requests](https://github.com/whitekeep/vpr12/pulls)
- При обнаружении орфаграфических или пунктационных ошибок вы можете самостоятельно редктировать инструкцию при наличии доступа
- Горох временно отсутствует

## Скачиваем образы дистрибутивов

Для выполнения этой лабы нам понадобиться скачать:

- [Oracle VirtualBox](https://download.virtualbox.org/virtualbox/6.1.32/VirtualBox-6.1.32-149290-Win.exe)
- [Ubuntu 20.04 LTS (в первой лабе был такой же)](https://releases.ubuntu.com/20.04.3/ubuntu-20.04.3-live-server-amd64.iso)

Можно использовать любой другой дистрибутив линукса. Главное чтобы была поддержка всех необходимых сетевых утилит

### Особенноти установки VirtualBox

- Необходиом согласиться на установку драйвера когда появиться соответсвующее диалоговое окно

### Особенности использования Ubuntu

- Аккуратнее с [выключением](./lab2.md#как-закрывать-машины) вм
- Во время исподьзования убунтой не выполняйте `apt upgrade`. Это излишне (выполняется 20 минут и займёт кучу места на диске)
- Всё делаем из под `sudo`
- Иногда опущенные интерфейсы сами поднимаются. Если это происходит, опускайте их снова. Следите за этим моментом

## Создание ВМ

- Создадим ВМ
- ![create](https://i.ibb.co/Y2tR2wd/image.png)
- Выбереем версию ОС
- ![create](https://i.ibb.co/4JSbrwj/image.png)
- Выбереем кол-во ОЗУ и жмем далее
- ![create](https://i.ibb.co/5RWTs7h/image.png)
- ![create](https://i.ibb.co/9wrpj4x/image.png)
- ![create](https://i.ibb.co/x6qQ1CC/image.png)
- ![create](https://i.ibb.co/MZf8stW/image.png)
- ![create](https://i.ibb.co/7SjtjVz/image.png)
- Настроим ВМ
- ![settings](https://i.imgur.com/fxdntyJ.png)
- Выберем образ Ubuntu или другой unix OS (в моем случае ссылка на файл сохранилась, выбирарю его)
- ![settings](https://i.imgur.com/PHetOky.png)
- Далее следует выбрать сеть, в которой будет работать наша почта (я выбрал всеми знакомый "виртуальный хост адаптера") и нажимаем "Ok"
- ![settings](https://i.imgur.com/8Xqg57u.png)
- ВМ создана, нам потребуется 1 сервер и 2 клиента => всего 3 машины. 
- Запускаем эту, устанавливаем ОС (процесс установки можно глянуть в инструкции 2й лабы)
- после установки ОС нужно послать сингнал завершения работы и клонировать машину 2 раза, чтобы получилось 3 машины:
- ![settings](https://i.imgur.com/miR7JtM.png)
- ![settings](https://i.imgur.com/UDaONlr.png)
- ![settings](https://i.imgur.com/IZFBw6f.png)
- Повторяем процедуру ещё 1 раз и получаем следующую картину:
- ![settings](https://i.imgur.com/s8kZKMf.png)

## Установка компонентов

Нам следует установить нужные компоненты, чтобы всё работало хорошо и чтобы не возвращаться к этому в будущем

Для серверной ВМ (в моем случае "mail-server") следует установить следующие компоненты: sendmail, ...
Чтобы это сделать, пропишите следующее в консоль:
- `sudo su` - после чего введите пароль
- `apt-get update`
- `apt-get install sendmail`
- ...

Для 2х оставшихся клиентских ВМ (в моем случае "mail-client" и "mail-client2") следует установить следующие компоненты: mutt, ...
Чтобы это сделать, пропишите следующее в консоль:
- `sudo su` - после чего введите пароль
- `apt-get update`
- `apt-get install mutt`
- ...


Но вы столкнетесь с проблемой того, что у Вас не будет доступа к интернету
потому что мы выбрали виртуальный хост адаптера (более надежный, чем NAT, но последний предоставляет доступ к интернету)
Следующий пункт для решения этой проблемы

### Временное включение интернета
Установим пару компонентов, но для начала включим интернет на время установки(операцию стоит провести для каждой ВМ отдельно):
- ![settings](https://i.imgur.com/IuznTwz.png)
- Переключимся временно на NAT
- ![settings](https://i.imgur.com/qYKuBtY.png)
- Устанавливаем компоненты с "включенным интернетом"
- ![settings](https://i.imgur.com/nucVssS.png)
Компоненты установлены, выключаем NAT
и включаем обратно наш адаптер виртуального хоста:
- ![settings](https://i.imgur.com/IuznTwz.png)
- ![settings](https://i.imgur.com/0WWmr1G.png)
Готово, можно приступать к основной работе

## Сбор информации, настройка статических IP
Чтобы нам не страдать, советую собрать ip всех машин в столбик,
а так же настроить статические ip на всех 3х машинах.

### Настройка статического ip
Зададим ip адрес вручную (без DHCP)

- Для ВМ "mail-server" я задам ip `192.168.56.105`
- Для ВМ "mail-client" - `192.168.56.106`
- Для ВМ "mail-client2" - `192.168.56.107`

- Почему именно такой? Просто потому что я так захотел

- Следующую процедуру следует повторить для каждой ВМ,
- я продемонстрирую на примере для ВМ "mail-server":

- Прописываем в консоль команду: `sudo nano /etc/netplan/*.yaml`
- Открылся редактор файла XXX.yaml; "nano" в linux - как программа "блокнот" в windows
![ipsettings](https://i.imgur.com/dl4om5J.png)
- Далее прописываем следующее, как у меня, только с вашим ip и сетью:
![ipsettings](https://i.imgur.com/biRnrln.png)
- Обратите внимание: стоит соблюдать отступы(пробелы)
- совет: смотрите под какой буквой какая строка начинается.

- Далее жмем `Ctrl+O` , далее `Enter` , далее `Ctrl+X`
Готово! Мы написали конфиг для ВМ "mail-server", теперь следует
его применить:

- Прописываем в консоль: `sudo netplan apply`
- А далее: `sudo netplan try`

- В консоли появилось предупреждение:
![ipsettings](https://i.imgur.com/j4ZvI5B.png)
- Жмем `Enter`
![ipsettings](https://i.imgur.com/924bS5D.png)
- Готово! Если нет ошибок, то всё получилось, 
если есть, то перепроверьте снова файл конфига и повторите процедуру.

- Можно проверить и удостовериться, что ip адрес поменялся на нужный нам, прописав ip a в консоль:
![ipsettings](https://i.imgur.com/hRVXxjz.png)
- Повторите процедуру для оставшихся машин


### Сбор информации о машинах
Соберем информацию о 3х машинах в столбик

|№|Интерфейс|ВМ mail-server|ВМ mail-client|ВМ mail-client2|
|---|---|---|---|---|
|1|enp0s3|`192.168.56.105`|`192.168.56.106`|`192.168.56.107`|

(У Вас ip может отличаться)

## Настройка почтового сервера
В моем случае я буду настраивать ВМ с названием "mail-server"

### Подготовка начальной конфигурации почтового сервера
- Откроем директорию `/etc/mail` прописав в консоль:
`cd /etc/mail`
![settings](https://i.imgur.com/nS3kGuJ.png)

В файле /etc/mail/access устанавливаются права доступа
Дадим разрешение на отправку почты от наших клиентов(ВМ "mail-client" и "mail-client2"), прописав
их ip адреса в столбик через любой редактор (например nano/vim) или просто введя в консоль:

- `echo "192.168.56.106 RELAY" >./access`
- `echo "192.168.56.107 RELAY" >./access`
- Где `192.168.56.106` и `192.168.56.107` - ip адреса разрешенных [клиентов](https://github.com/whitekeep/vpr12/blob/main/seti/lab3/lab3.md#%D1%81%D0%B1%D0%BE%D1%80-%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%86%D0%B8%D0%B8-%D0%BE-%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D0%B0%D1%85) (ВМ mail-client и ВМ mail-client2)

- Создадим таблицу разрешенных клиентов, введя в консоль:
- `make access.db`

![settings](https://i.imgur.com/M47whUa.png)
Готово


